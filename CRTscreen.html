<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcast Display Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Generation Library -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .marquee {
            display: inline-block;
            animation: marquee 80s linear infinite;
            padding-left: 100%; /* Start off-screen */
        }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }
        @keyframes scroll-up {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); }
        }
        .scrolling-events-container {
            animation: scroll-up linear infinite;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
            border: 2px solid #1f2937;
        }
        #controls-container.hidden-panel { transform: translateY(-100%); }
        :root {
            --brand-water: #1e29f5;
            --brand-deep-water: #00416e;
            --brand-sky: #33d8ff;
            --brand-dawn: #ffd400;
            --brand-leaf: #0086a6;
            --brand-poppy: #e64f00;
            --brand-panel-bg: #1f2937;
        }
        .mode-btn-active {
            background-color: var(--brand-dawn) !important;
            color: var(--brand-deep-water) !important;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-white flex flex-col h-screen overflow-hidden">

    <!-- CONTROLS SECTION (Shared) -->
    <div id="controls-container" class="bg-[var(--brand-panel-bg)]/95 backdrop-blur-sm p-4 shadow-lg fixed top-0 left-0 right-0 z-20 transform transition-transform duration-300 ease-in-out hidden-panel">
        <h1 class="text-xl font-bold text-center mb-4" style="color: var(--brand-sky);">Broadcast Control Panel</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
            <!-- YouTube Playlist Controls -->
            <div class="space-y-2">
                <label for="youtube-link" class="block font-semibold">Add YouTube Video to Playlist</label>
                <div class="flex">
                    <input type="text" id="youtube-link" placeholder="Paste YouTube URL here..." class="w-full bg-gray-700 border border-gray-600 rounded-l-md px-3 py-2 focus:outline-none focus:ring-2" style="border-color: var(--brand-water); --tw-ring-color: var(--brand-sky);">
                    <button id="add-video-btn" class="text-white font-bold py-2 px-4 rounded-r-md transition-opacity hover:opacity-90" style="background-color: var(--brand-water);">Add</button>
                </div>
                <h3 class="font-semibold pt-2">Video Playlist:</h3>
                <div id="playlist-controls" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 bg-black/20 p-2 rounded"></div>
            </div>

            <!-- Event Calendar Controls -->
            <div class="space-y-2">
                <label for="event-title" class="block font-semibold">Events Section Title</label>
                <input type="text" id="event-title" placeholder="e.g., Events & Notes" value="Events & Notes" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2" style="border-color: var(--brand-leaf); --tw-ring-color: var(--brand-sky);">
                
                <label for="event-text" class="block font-semibold pt-2">Add Event / Note</label>
                 <div class="flex">
                    <input type="text" id="event-text" placeholder="Enter event title or note..." class="w-full bg-gray-700 border border-gray-600 rounded-l-md px-3 py-2 focus:outline-none focus:ring-2" style="border-color: var(--brand-leaf); --tw-ring-color: var(--brand-sky);">
                    <button id="add-event-btn" class="text-white font-bold py-2 px-4 rounded-r-md transition-opacity hover:opacity-90" style="background-color: var(--brand-leaf);">Add</button>
                </div>
                <h3 class="font-semibold pt-2">Current Events:</h3>
                <div id="event-list-controls" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 bg-black/20 p-2 rounded"></div>
            </div>

            <!-- Ticker Controls -->
            <div class="space-y-2">
                <label for="ticker-message" class="block font-semibold">Add Ticker Message</label>
                <div class="flex">
                    <input type="text" id="ticker-message" placeholder="Enter new message..." class="w-full bg-gray-700 border border-gray-600 rounded-l-md px-3 py-2 focus:outline-none focus:ring-2" style="border-color: var(--brand-poppy); --tw-ring-color: var(--brand-sky);">
                    <button id="add-ticker-btn" class="text-white font-bold py-2 px-4 rounded-r-md transition-opacity hover:opacity-90" style="background-color: var(--brand-poppy);">Add</button>
                </div>
                 <div class="pt-2">
                    <label class="block font-semibold">Ticker Mode</label>
                    <div class="flex space-x-2 mt-1">
                        <button id="continuous-mode-btn" class="flex-1 text-sm py-2 px-3 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors">Continuous Loop</button>
                        <button id="individual-mode-btn" class="flex-1 text-sm py-2 px-3 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors">Individual Loop</button>
                    </div>
                </div>
                <div class="pt-2">
                    <label for="ticker-speed" class="block font-semibold">Scroll Speed</label>
                    <div class="flex items-center space-x-2 text-sm text-gray-400 mt-1">
                        <span>Fast</span>
                        <input type="range" id="ticker-speed" min="10" max="600" value="150" class="w-full accent-[var(--brand-dawn)]">
                        <span>Slow</span>
                    </div>
                </div>
                 <h3 class="font-semibold pt-2">Ticker Messages:</h3>
                <div id="ticker-list-controls" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2 bg-black/20 p-2 rounded"></div>
            </div>

            <!-- Graphics Controls -->
            <div class="space-y-2">
                <label class="block font-semibold">Generate QR Code</label>
                <div class="space-y-2 bg-gray-700/50 p-3 rounded-md border border-gray-600">
                    <input type="text" id="qr-code-title" placeholder="Enter QR Code Title..." class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2" style="border-color: var(--brand-dawn); --tw-ring-color: var(--brand-sky);">
                    <input type="url" id="qr-code-url" placeholder="Enter URL for QR Code..." class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2" style="border-color: var(--brand-dawn); --tw-ring-color: var(--brand-sky);">
                    <button id="add-qr-btn" class="w-full text-white font-bold py-2 px-4 rounded-md transition-opacity hover:opacity-90 mt-1" style="background-color: var(--brand-dawn); color: var(--brand-deep-water);">Generate QR Code</button>
                </div>
                <div class="space-y-2 bg-gray-700/50 p-3 rounded-md border border-gray-600">
                     <label for="qr-rotation-time" class="text-sm font-semibold">Rotation Interval (seconds)</label>
                     <input type="number" id="qr-rotation-time" value="10" min="1" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2" style="border-color: var(--brand-dawn); --tw-ring-color: var(--brand-sky);">
                </div>
                 <h3 class="font-semibold pt-2">Available QR Codes:</h3>
                <div id="qr-code-list-controls" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2 bg-black/20 p-2 rounded"></div>
            </div>
        </div>
    </div>
    
    <!-- Toggle Controls Button (Shared) -->
    <!-- This button is now hidden as requested -->
    <button id="toggle-controls-btn" class="fixed top-4 right-4 z-30 bg-gray-700/50 p-2 rounded-full hover:bg-gray-600/70 transition-colors hidden">
        <svg id="settings-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>

    <!-- ########## LANDSCAPE LAYOUT ########## -->
    <div id="landscape-layout" class="hidden lg:flex flex-col flex-1 h-screen">
        <!-- MAIN DISPLAY AREA (Landscape) -->
        <div class="flex flex-1 min-h-0 pt-4">
            <!-- *** VIDEO WRAPPER 1 *** -->
            <main class="flex-1 p-4 md:p-6 flex flex-col">
                <div id="landscape-video-wrapper" class="w-full bg-black rounded-lg shadow-2xl flex-1 relative aspect-video">
                    <!-- The single player container will be *moved* here by JS -->
                    <!-- This div contains the single player on load -->
                    <div id="youtube-player-container" class="w-full h-full"></div>
                </div>
            </main>
            <aside class="w-full md:w-1/3 lg:w-1/4 p-4 flex flex-col" style="background-color: var(--brand-panel-bg);">
                <h2 id="event-title-display-landscape" class="text-2xl font-bold mb-4 pb-2 border-b-2 text-center" style="border-color: var(--brand-water);">Events & Notes</h2>
                <div id="event-list-display" class="flex-1 overflow-hidden pr-2"></div>
                <!-- QR Code Placeholder (Landscape) -->
                <div id="qr-code-display-area" class="mt-4 w-3/4 max-w-[200px] mx-auto">
                    <h3 id="qr-code-title-display" class="text-center font-bold text-lg mb-2 h-12 flex items-center justify-center" style="color: var(--brand-sky); line-height: 1.2;"></h3>
                    <div id="qr-code-container" class="p-2 bg-white rounded-lg aspect-square flex items-center justify-center">
                        <span class="text-sm text-gray-500 text-center">No QR Code Active</span>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Bottom Ticker (Landscape) -->
        <footer class="h-16 shadow-inner flex items-center overflow-hidden relative border-t-4" style="background-color: var(--brand-water); border-color: var(--brand-dawn);">
            <!-- LOGO PLACEHOLDER -->
            <div class="h-full w-48 bg-black/20 flex-shrink-0 flex items-center justify-center z-10 p-2">
                <img src="https://www.dropbox.com/scl/fi/6hh4aygdngjrbcu1vnbr5/white-logo-new.png?rlkey=3fbkidr2jqhpjp52tjmp66q7e&raw=1" alt="Canal & River Trust Logo" class="h-12 object-contain">
            </div>
            <!-- TICKER WRAPPER -->
            <div class="flex-1 h-full relative overflow-hidden">
                <div id="ticker-text-container" class="absolute whitespace-nowrap w-full h-full flex items-center">
                    <!-- Ticker content is dynamically inserted here -->
                </div>
            </div>
            <!-- CLOCK CONTAINER -->
            <div id="clock-container" class="h-full w-48 bg-black/20 flex-shrink-0 flex items-center justify-center z-10 p-2 text-2xl font-bold">
                <!-- Clock will be inserted here -->
            </div>
        </footer>
    </div>
    <!-- ########## END LANDSCAPE LAYOUT ########## -->


    <!-- ########## PORTRAIT LAYOUT ########## -->
    <div id="portrait-layout" class="flex lg:hidden flex-col flex-1 h-screen">
        <!-- Top Bar (Portrait) -->
        <header class="h-16 shadow-inner flex items-center justify-between overflow-hidden relative border-b-4 p-2" style="background-color: var(--brand-water); border-color: var(--brand-dawn);">
            <!-- LOGO PLACEHOLDER -->
            <div class="h-full w-48 flex-shrink-0 flex items-center justify-start z-10">
                <img src="https://www.dropbox.com/scl/fi/6hh4aygdngjrbcu1vnbr5/white-logo-new.png?rlkey=3fbkidr2jqhpjp52tjmp66q7e&raw=1" alt="Canal & River Trust Logo" class="h-12 object-contain">
            </div>
            <!-- CLOCK CONTAINER (Portrait) -->
            <div id="clock-container-vertical" class="h-full w-32 flex-shrink-0 flex items-center justify-center z-10 p-2 text-2xl font-bold">
                <!-- Clock will be inserted here -->
            </div>
        </header>
        
        <!-- Vertical Banner -->
        <div id="vertical-banner-container" class="w-full px-4 pt-4 lg:hidden">
            <img id="vertical-banner-image" src="" alt="Campaign Banner" class="w-full h-auto object-contain rounded-lg">
        </div>

        <!-- *** VIDEO WRAPPER 2 *** -->
        <main class="w-full p-4 pt-4 flex flex-col"> <!-- Adjusted padding -->
            <div id="portrait-video-wrapper" class="w-full bg-black rounded-lg shadow-2xl relative aspect-video">
                <!-- The single player container will be *moved* here by JS -->
            </div>
        </main>
        
        <!-- Content Area (Portrait) -->
        <div class="flex flex-1 p-4 pt-0 min-h-0" style="background-color: var(--brand-panel-bg);">
            <!-- Events (Portrait) -->
            <aside class="w-4/5 pr-2 flex flex-col overflow-hidden">
                <h2 id="event-title-display-portrait" class="text-xl font-bold mb-4 pb-2 border-b-2 text-center" style="border-color: var(--brand-water);">Events & Notes</h2>
                <!-- *** SCROLLING FIX: Added min-h-0 here *** -->
                <div id="event-list-display-vertical" class="flex-1 overflow-hidden pr-2 min-h-0"></div>
            </aside>
            <!-- QR Code (Portrait) -->
            <aside class="w-1/5 pl-2 flex flex-col justify-end">
                 <!-- <h2 class="text-xl font-bold mb-4 pb-2 border-b-2 text-center" style="border-color: var(--brand-sky);">Scan QR</h2> -->
                <!-- QR 1 -->
                <div id="qr-code-display-area-vertical" class="w-full">
                    <h3 id="qr-code-title-display-vertical" class="text-center font-bold text-sm mb-2 h-10 flex items-center justify-center" style="color: var(--brand-sky); line-height: 1.2;"></h3>
                    <div id="qr-code-container-vertical" class="p-1 bg-white rounded-lg aspect-square flex items-center justify-center">
                        <span class="text-sm text-gray-500 text-center">No QR Code Active</span>
                    </div>
                </div>
            </aside>
        </div>
        
        <!-- Bottom Ticker (Portrait) -->
        <footer class="h-16 shadow-inner flex items-center overflow-hidden relative border-t-4" style="background-color: var(--brand-water); border-color: var(--brand-dawn);">
            <div class="flex-1 h-full relative overflow-hidden">
                <div id="ticker-text-container-vertical" class="absolute whitespace-nowrap w-full h-full flex items-center">
                    <!-- Ticker content is dynamically inserted here -->
                </div>
            </div>
        </footer>
    </div>
    <!-- ########## END PORTRAIT LAYOUT ########## -->

    
    <div id="notification" class="fixed bottom-5 right-5 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // State Management
        let videoPlaylist = [];
        let currentVideoIndex = 0;
        let eventItems = [];
        let eventListTitle = "Events & Notes"; // New state for the title
        let qrCodes = [];
        let tickerMessages = [];
        let activeQrCodeId = null;
        let tickerMode = 'continuous'; // 'continuous' or 'individual'
        let currentTickerIndex = 0;
        let player; // *** Only ONE player ***
        let notificationTimeout;
        let qrRotationTimerId = null;
        
        // Banner State
        const bannerImages = [
            "https://www.dropbox.com/scl/fi/nz9rkugjl0m2ki88bavlu/We-re-the-charity-for-LinkedIn-1.png?rlkey=9sn8nujd7wocehqrr1m4nm7u7&st=p82c0sxj&raw=1",
            "https://www.dropbox.com/scl/fi/zwgx2izd34a3nq5qf13pb/We-re-the-charity-for-LinkedIn-2.png?rlkey=xfhitg9e5i4gjg38g345vchlh&st=jim775c7&raw=1",
            "https://www.dropbox.com/scl/fi/w93r1hipgk36j3u5q8klq/We-re-the-charity-for-LinkedIn-3.png?rlkey=ewq2nd3qmw19x1c71k8t8vwhz&st=arz79cnq&raw=1",
            "https://www.dropbox.com/scl/fi/vyoi7cbifapsl9c84dskw/We-re-the-charity-for-LinkedIn-4.png?rlkey=1yldqc384vogsl3yxe13hgbrw&st=hhaodah0&raw=1",
            "https://www.dropbox.com/scl/fi/ivu0blhtmgz8ztyf9k72h/We-re-the-charity-for-LinkedIn-5.png?rlkey=i6inzm4leumi58tmp9h3k5chc&st=q731s0yd&raw=1"
        ];
        let currentBannerIndex = 0;
        let bannerRotationTimerId = null;


        // DOM Elements
        const controlsContainer = document.getElementById('controls-container');
        const toggleControlsBtn = document.getElementById('toggle-controls-btn');
        const settingsIcon = document.getElementById('settings-icon');
        const closeIcon = document.getElementById('close-icon');
        const youtubeLinkInput = document.getElementById('youtube-link');
        const addVideoBtn = document.getElementById('add-video-btn');
        const playlistControls = document.getElementById('playlist-controls');
        
        // Landscape Elements
        const eventListDisplay = document.getElementById('event-list-display');
        const eventTitleDisplayLandscape = document.getElementById('event-title-display-landscape');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const qrCodeTitleDisplay = document.getElementById('qr-code-title-display');
        const tickerTextContainer = document.getElementById('ticker-text-container');
        const clockContainer = document.getElementById('clock-container');
        
        // Portrait Elements
        const eventListDisplayVertical = document.getElementById('event-list-display-vertical');
        const eventTitleDisplayPortrait = document.getElementById('event-title-display-portrait');
        const tickerTextContainerVertical = document.getElementById('ticker-text-container-vertical');
        const clockContainerVertical = document.getElementById('clock-container-vertical');
        const verticalBannerImage = document.getElementById('vertical-banner-image');
        const qrCodeContainerVertical = document.getElementById('qr-code-container-vertical');
        const qrCodeTitleDisplayVertical = document.getElementById('qr-code-title-display-vertical');


        // Control Panel Elements (Shared)
        const eventTitleInput = document.getElementById('event-title');
        const eventTextInput = document.getElementById('event-text');
        const addEventBtn = document.getElementById('add-event-btn');
        const eventListControls = document.getElementById('event-list-controls');
        const addTickerBtn = document.getElementById('add-ticker-btn');
        const tickerMessageInput = document.getElementById('ticker-message');
        const tickerSpeedInput = document.getElementById('ticker-speed');
        const tickerListControls = document.getElementById('ticker-list-controls');
        const continuousModeBtn = document.getElementById('continuous-mode-btn');
        const individualModeBtn = document.getElementById('individual-mode-btn');
        const notification = document.getElementById('notification');
        const qrCodeUrlInput = document.getElementById('qr-code-url');
        const qrCodeTitleInput = document.getElementById('qr-code-title');
        const addQrBtn = document.getElementById('add-qr-btn');
        const qrCodeListControls = document.getElementById('qr-code-list-controls');
        const qrRotationTimeInput = document.getElementById('qr-rotation-time');

        // --- Clock Function ---
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            
            const timeString = `${hours}:${minutes} ${ampm}`;
            
            if (clockContainer) clockContainer.textContent = timeString;
            if (clockContainerVertical) clockContainerVertical.textContent = timeString;
        }

        // --- YouTube Player API ---
        function onYouTubeIframeAPIReady() {
            const playerConfig = {
                height: '100%',
                width: '100%',
                playerVars: {
                    'playsinline': 1, 'autoplay': 1, 'controls': 0, 'mute': 0,
                    'loop': 0, 'rel': 0, 'showinfo': 0, 'modestbranding': 1, 'playlist': ''
                },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            };

            // *** Init ONE player in the container ***
            player = new YT.Player('youtube-player-container', playerConfig);
        }

        function onPlayerReady(event) {
            if (videoPlaylist.length > 0) {
                playVideo(currentVideoIndex);
            }
        }

        function onPlayerStateChange(event) {
            // No need to check event.target, there is only one player
            if (event.data === YT.PlayerState.ENDED && videoPlaylist.length > 0) {
                currentVideoIndex = (currentVideoIndex + 1) % videoPlaylist.length;
                playVideo(currentVideoIndex);
            }
        }

        // *** NEW: Function to move the player between layouts ***
        function handleResize() {
            const playerContainer = document.getElementById('youtube-player-container');
            const portraitWrapper = document.getElementById('portrait-video-wrapper');
            const landscapeWrapper = document.getElementById('landscape-video-wrapper');

            if (!playerContainer || !portraitWrapper || !landscapeWrapper) return;

            if (window.innerWidth < 1024) {
                // Portrait
                if (playerContainer.parentElement !== portraitWrapper) {
                    portraitWrapper.appendChild(playerContainer);
                }
            } else {
                // Landscape
                if (playerContainer.parentElement !== landscapeWrapper) {
                    landscapeWrapper.appendChild(playerContainer);
                }
            }
        }
        // Add resize listener
        window.addEventListener('resize', handleResize);


        // --- Event Listeners ---
        toggleControlsBtn.addEventListener('click', toggleControls);
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.code === 'KeyM') { e.preventDefault(); toggleControls(); }
        });

        addVideoBtn.addEventListener('click', addVideo);
        youtubeLinkInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') addVideo(); });

        eventTitleInput.addEventListener('input', () => {
            eventListTitle = eventTitleInput.value.trim() || "Events & Notes";
            renderEventTitle();
            saveState();
        });

        addEventBtn.addEventListener('click', addEvent);
        eventTextInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') addEvent(); });

        addTickerBtn.addEventListener('click', addTickerMessage);
        tickerMessageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') addTickerMessage(); });
        
        continuousModeBtn.addEventListener('click', () => setTickerMode('continuous'));
        individualModeBtn.addEventListener('click', () => setTickerMode('individual'));

        tickerSpeedInput.addEventListener('input', () => {
            updateTickerDisplay();
            saveState();
        });
        
        addQrBtn.addEventListener('click', addQrCode);
        qrRotationTimeInput.addEventListener('change', manageQrRotation);
        
        // --- Core Functions ---
        function saveState() {
            try {
                const state = {
                    videoPlaylist, eventItems, eventListTitle,
                    qrCodes, tickerMessages,
                    activeQrCodeId, tickerMode,
                    tickerSpeed: tickerSpeedInput.value,
                    qrRotationInterval: qrRotationTimeInput.value
                };
                localStorage.setItem('broadcastToolState', JSON.stringify(state));
            } catch (error) {
                console.error("Could not save state to localStorage:", error);
                showNotification("Error: Could not save settings.");
            }
        }

        function loadState() {
            const savedState = localStorage.getItem('broadcastToolState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    videoPlaylist = state.videoPlaylist || [];
                    eventItems = state.eventItems || [];
                    eventListTitle = state.eventListTitle || "Events & Notes";
                    qrCodes = state.qrCodes || [];
                    tickerMessages = state.tickerMessages || [];
                    activeQrCodeId = state.activeQrCodeId || null;
                    tickerMode = state.tickerMode || 'continuous';
                    tickerSpeedInput.value = state.tickerSpeed || 150;
                    qrRotationTimeInput.value = state.qrRotationInterval || 10;
                    eventTitleInput.value = eventListTitle;
                } catch (error) {
                    console.error("Could not parse saved state:", error);
                }
            }
        }

        function getYouTubeID(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            return url.match(regex)?.[1] || null;
        }

        async function getVideoTitle(videoId) {
            try {
                const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                const data = await response.json();
                return data.title || 'Untitled Video';
            } catch (error) {
                console.error('Error fetching video title:', error);
                return 'Untitled Video';
            }
        }

        async function addVideo() {
            const url = youtubeLinkInput.value.trim();
            const videoId = getYouTubeID(url);
            if (videoId) {
                const title = await getVideoTitle(videoId);
                videoPlaylist.push({ id: videoId, title: title });
                renderPlaylistControls();
                youtubeLinkInput.value = '';
                if (videoPlaylist.length === 1) {
                    currentVideoIndex = 0;
                    playVideo(currentVideoIndex);
                }
                saveState();
            } else { showNotification('Invalid YouTube URL'); }
        }

        function playVideo(index) {
            if (videoPlaylist[index]) {
                currentVideoIndex = index;
                const videoId = videoPlaylist[index].id;
                // *** Only need to load on ONE player ***
                if (player && player.loadVideoById) player.loadVideoById(videoId);
                renderPlaylistControls();
            }
        }

        function deleteVideo(index) {
            videoPlaylist.splice(index, 1);
            if (index === currentVideoIndex) {
                if (videoPlaylist.length > 0) {
                    currentVideoIndex = Math.max(0, index - 1);
                    playVideo(currentVideoIndex);
                } else {
                    // *** Only need to stop ONE player ***
                    if (player && player.stopVideo) {
                        player.stopVideo();
                        player.mute();
                    }
                }
            } else if (index < currentVideoIndex) { currentVideoIndex--; }
            renderPlaylistControls();
            saveState();
        }

        function renderPlaylistControls() {
            playlistControls.innerHTML = videoPlaylist.length === 0 ? '<p class="text-gray-400">No videos in playlist.</p>' : '';
            videoPlaylist.forEach((video, index) => {
                const isPlaying = index === currentVideoIndex;
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded ${isPlaying ? 'bg-sky-500/50' : 'bg-gray-700'}`;
                item.innerHTML = `
                    <p class="text-sm truncate flex-1 mr-2 ${isPlaying ? 'font-bold' : ''}">${video.title}</p>
                    <button onclick="deleteVideo(${index})" class="text-red-400 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
                playlistControls.appendChild(item);
            });
        }
        
        function toggleControls() {
            controlsContainer.classList.toggle('hidden-panel');
            settingsIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        }

        function showNotification(message) {
            notification.textContent = message;
            notification.classList.remove('opacity-0');
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => { notification.classList.add('opacity-0'); }, 3000);
        }

        function renderEventTitle() {
            if (eventTitleDisplayLandscape) eventTitleDisplayLandscape.textContent = eventListTitle;
            if (eventTitleDisplayPortrait) eventTitleDisplayPortrait.textContent = eventListTitle;
        }

        function addEvent() {
            const value = eventTextInput.value.trim();
            if (value) {
                eventItems.push({ id: Date.now(), text: value });
                renderEventLists();
                eventTextInput.value = '';
                saveState();
            }
        }

        function deleteEvent(idToDelete) {
            eventItems = eventItems.filter(item => item.id !== idToDelete);
            renderEventLists();
            saveState();
        }

        function renderEventLists() {
            // Clear all three lists
            eventListDisplay.innerHTML = '';
            eventListDisplayVertical.innerHTML = '';
            eventListControls.innerHTML = eventItems.length === 0 ? '<p class="text-gray-400">No events added.</p>' : '';
            
            // Render controls list
            eventItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 rounded bg-gray-700';
                div.innerHTML = `<p class="text-sm truncate flex-1 mr-2">${item.text}</p><button onclick="deleteEvent(${item.id})" class="text-red-400 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
                eventListControls.appendChild(div);
            });

            if (eventItems.length === 0) {
                const noEventsMsg = '<p class="text-gray-400 text-center">No events or notes.</p>';
                eventListDisplay.innerHTML = noEventsMsg;
                eventListDisplayVertical.innerHTML = noEventsMsg;
                return;
            }
            
            // Create container for display lists
            const eventsContainer = document.createElement('div');
            eventItems.forEach(item => {
                const p = document.createElement('p');
                p.className = 'bg-gray-800/50 p-3 rounded-lg border-l-4 mb-3';
                p.style.borderColor = 'var(--brand-leaf)';
                p.textContent = item.text;
                eventsContainer.appendChild(p);
            });

            // Append to landscape display
            eventListDisplay.appendChild(eventsContainer);
            
            // Append clone to portrait display
            eventListDisplayVertical.appendChild(eventsContainer.cloneNode(true));


            // Handle scrolling animation for both
            setTimeout(() => {
                // Landscape
                if (eventsContainer.parentElement) {
                    const isOverflowing = eventsContainer.scrollHeight > eventsContainer.parentElement.clientHeight;
                    if (isOverflowing) {
                        const originalItems = Array.from(eventsContainer.children);
                        originalItems.forEach(item => { eventsContainer.appendChild(item.cloneNode(true)); });
                        const duration = eventItems.length * 16;
                        eventsContainer.style.animationDuration = `${duration}s`;
                        eventsContainer.classList.add('scrolling-events-container');
                    } else {
                        eventListDisplay.classList.remove('overflow-hidden');
                        eventListDisplay.classList.add('overflow-y-auto', 'custom-scrollbar');
                    }
                }

                // Portrait
                const eventsContainerVertical = eventListDisplayVertical.querySelector('div');
                if (eventsContainerVertical && eventsContainerVertical.parentElement) { 
                    const isOverflowingVertical = eventsContainerVertical.scrollHeight > eventsContainerVertical.parentElement.clientHeight;
                    if (isOverflowingVertical) {
                        const originalItemsVert = Array.from(eventsContainerVertical.children);
                        originalItemsVert.forEach(item => { eventsContainerVertical.appendChild(item.cloneNode(true)); });
                        const durationVert = eventItems.length * 16;
                        eventsContainerVertical.style.animationDuration = `${durationVert}s`;
                        eventsContainerVertical.classList.add('scrolling-events-container');
                    } else {
                        eventListDisplayVertical.classList.remove('overflow-hidden');
                        eventListDisplayVertical.classList.add('overflow-y-auto', 'custom-scrollbar');
                    }
                }
            }, 100);
        }

        // --- Ticker Functions ---
        function setTickerMode(mode) {
            tickerMode = mode;
            updateTickerDisplay();
            saveState();
        }
        
        function updateTickerDisplay() {
            // Clear both tickers
            tickerTextContainer.innerHTML = '';
            tickerTextContainerVertical.innerHTML = '';

            updateTickerModeButtons();

            if (tickerMode === 'continuous') { buildContinuousTicker(); } 
            else { currentTickerIndex = -1; playNextIndividualTicker(); }
        }

        function buildContinuousTicker() {
            const speed = tickerSpeedInput.value;
            let message = tickerMessages.length > 0 ? tickerMessages.map(t => t.text).join(' • ') : "Welcome! Use Ctrl+M to open controls.";
            const repeatedMessage = (message + ' • ').repeat(10);
            const tickerHTML = `<span class="text-2xl font-bold uppercase px-8 marquee" style="animation-duration: ${speed}s;">${repeatedMessage}</span>`;
            
            tickerTextContainer.innerHTML = tickerHTML;
            tickerTextContainerVertical.innerHTML = tickerHTML;
        }

        function playNextIndividualTicker() {
            if (tickerMessages.length === 0) {
                tickerTextContainer.innerHTML = '';
                tickerTextContainerVertical.innerHTML = '';
                return;
            }

            currentTickerIndex = (currentTickerIndex + 1) % tickerMessages.length;
            const message = tickerMessages[currentTickerIndex].text;
            const speed = tickerSpeedInput.value;
            
            // Create span for landscape
            const span = document.createElement('span');
            span.className = 'text-2xl font-bold uppercase px-8 marquee';
            span.style.animationDuration = `${speed}s`;
            span.textContent = message;
            
            // Create span for portrait
            const spanVertical = span.cloneNode(true);

            // Add listeners
            span.addEventListener('animationend', playNextIndividualTicker, { once: true });
            // Note: Only one listener is needed to advance the queue
            
            // Add to DOM
            tickerTextContainer.innerHTML = '';
            tickerTextContainerVertical.innerHTML = '';
            tickerTextContainer.appendChild(span);
            tickerTextContainerVertical.appendChild(spanVertical);
        }

        function addTickerMessage() {
            const message = tickerMessageInput.value.trim();
            if (message) {
                tickerMessages.push({ id: Date.now(), text: message });
                updateTickerDisplay();
                renderTickerList();
                tickerMessageInput.value = '';
                saveState();
            } else { showNotification('Please enter a message for the ticker.'); }
        }

        function deleteTickerMessage(id) {
            tickerMessages = tickerMessages.filter(t => t.id !== id);
            updateTickerDisplay();
            renderTickerList();
            saveState();
        }
        
        function renderTickerList() {
            tickerListControls.innerHTML = tickerMessages.length === 0 ? '<p class="text-gray-400">No messages saved.</p>' : '';
            tickerMessages.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 rounded bg-gray-700';
                div.innerHTML = `<p class="text-sm truncate flex-1 mr-2">${item.text}</p><button onclick="deleteTickerMessage(${item.id})" class="text-red-400 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
                tickerListControls.appendChild(div);
            });
        }
        
        function updateTickerModeButtons() {
            continuousModeBtn.classList.toggle('mode-btn-active', tickerMode === 'continuous');
            individualModeBtn.classList.toggle('mode-btn-active', tickerMode === 'individual');
        }

        // --- Graphics Functions ---
        function addQrCode() {
            const title = qrCodeTitleInput.value.trim();
            const url = qrCodeUrlInput.value.trim();

            if (!title) { showNotification('Please enter a title for the QR code.'); return; }
            if (!url) { showNotification('Please enter a URL for the QR code.'); return; }

            const tempDiv = document.createElement('div');
            new QRCode(tempDiv, {
                text: url,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const img = tempDiv.querySelector('img');
                const canvas = tempDiv.querySelector('canvas');
                
                if (!img && !canvas) {
                     showNotification('Error generating QR code.');
                     return;
                }
                
                const imageDataUrl = canvas ? canvas.toDataURL() : img.src;

                const newQr = { id: Date.now(), title: title, imageDataUrl: imageDataUrl, url: url };
                qrCodes.push(newQr);
                if (qrCodes.length === 1) { 
                    setActiveQrCode(newQr.id); // Set slot 1 by default
                }
                
                renderQrCodeList();
                qrCodeTitleInput.value = '';
                qrCodeUrlInput.value = '';
                manageQrRotation();
                saveState();
            }, 100);
        }

        function setActiveQrCode(id) {
            activeQrCodeId = id;
            renderActiveQrCode();
            renderQrCodeList();
            saveState();
        }

        function deleteQrCode(idToDelete) {
            const deletedIndex = qrCodes.findIndex(qr => qr.id === idToDelete);
            qrCodes = qrCodes.filter(qr => qr.id !== idToDelete);
            
            if (activeQrCodeId === idToDelete) {
                activeQrCodeId = qrCodes.length > 0 ? qrCodes[Math.max(0, deletedIndex - 1)].id : null;
            }

            renderActiveQrCode();
            renderQrCodeList();
            manageQrRotation();
            saveState();
        }


        function renderQrCodeList() {
            qrCodeListControls.innerHTML = qrCodes.length === 0 ? '<p class="text-gray-400">No QR codes added.</p>' : '';
            qrCodes.forEach(qr => {
                const isActive = qr.id === activeQrCodeId;
                let bgColor = isActive ? 'bg-yellow-500/50' : 'bg-gray-700';

                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded ${bgColor}`;
                item.innerHTML = `
                    <p class="truncate text-sm flex-1 mr-2 ${isActive ? 'text-white font-semibold' : ''}">${qr.title}</p>
                    <div class="flex items-center space-x-1 flex-shrink-0">
                        <button onclick="setActiveQrCode(${qr.id})" class="show-qr-btn text-green-400 hover:text-green-300" title="Show"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></button>
                        <button onclick="deleteQrCode(${qr.id})" class="delete-qr-btn text-red-400 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                    </div>`;
                qrCodeListControls.appendChild(item);
            });
        }
        
        function renderActiveQrCode() {
            const activeQr = qrCodes.find(qr => qr.id === activeQrCodeId);
            
            // --- Update Landscape (Slot 1) ---
            const titleEl = qrCodeTitleDisplay;
            if (activeQr) {
                titleEl.textContent = activeQr.title;
                qrCodeContainer.innerHTML = `<img src="${activeQr.imageDataUrl}" alt="${activeQr.title}" class="w-full h-full object-contain">`;
            } else {
                titleEl.textContent = '';
                qrCodeContainer.innerHTML = '<span class="text-sm text-gray-500 text-center">No QR Code Active</span>';
            }

            // --- Update Portrait Slot 1 ---
            const titleElVertical = qrCodeTitleDisplayVertical;
            if (activeQr) {
                titleElVertical.textContent = activeQr.title;
                qrCodeContainerVertical.innerHTML = `<img src="${activeQr.imageDataUrl}" alt="${activeQr.title}" class="w-full h-full object-contain">`;
            } else {
                titleElVertical.textContent = '';
                qrCodeContainerVertical.innerHTML = '<span class="text-sm text-gray-500 text-center">No QR Code Active</span>';
            }


            // Auto-fit font size
            [titleEl, titleElVertical].forEach((el) => {
                if (activeQr) {
                    setTimeout(() => {
                        el.style.fontSize = ''; 
                        const initialFontSize = parseFloat(getComputedStyle(el).fontSize);
                        let currentFontSize = initialFontSize;
                        while (el.scrollHeight > el.clientHeight && currentFontSize > 10) { 
                            currentFontSize--;
                            el.style.fontSize = `${currentFontSize}px`;
                        }
                    }, 0);
                } else {
                    el.style.fontSize = '';
                }
            });
        }
        
        function manageQrRotation() {
            if (qrRotationTimerId) {
                clearInterval(qrRotationTimerId);
                qrRotationTimerId = null;
            }

            if (qrCodes.length < 2) return;

            const intervalSeconds = parseInt(qrRotationTimeInput.value, 10);
            if (isNaN(intervalSeconds) || intervalSeconds < 1) return;

            qrRotationTimerId = setInterval(() => {
                const currentIdx = qrCodes.findIndex(qr => qr.id === activeQrCodeId);
                const nextIdx = (currentIdx + 1) % qrCodes.length;
                setActiveQrCode(qrCodes[nextIdx].id); // Only rotate slot 1
            }, intervalSeconds * 1000);
        }

        // --- Banner Function ---
        function startBannerRotation() {
            if (bannerRotationTimerId) clearInterval(bannerRotationTimerId);
            if (!verticalBannerImage || bannerImages.length === 0) return;

            // Set initial image
            verticalBannerImage.src = bannerImages[currentBannerIndex];

            // Start rotation
            bannerRotationTimerId = setInterval(() => {
                currentBannerIndex = (currentBannerIndex + 1) % bannerImages.length;
                verticalBannerImage.src = bannerImages[currentBannerIndex];
            }, 60000); // 60 seconds
        }

        // --- Initial Load ---
        async function initializeApp() {
            // *** Move player to correct initial position ***
            handleResize(); 

            const isFirstLoad = !localStorage.getItem('broadcastToolState');
            loadState();

            if (isFirstLoad) {
                // --- Set default YouTube videos ---
                const defaultVideoUrls = [
                    "https//www.youtube.com/watch?v=6TMPCH1kdZk",
                    "https//www.youtube.com/watch?v=vTTlgpU-rRs"
                ];
                for (const url of defaultVideoUrls) {
                    const videoId = getYouTubeID(url);
                    if (videoId) {
                        const title = await getVideoTitle(videoId);
                        videoPlaylist.push({ id: videoId, title: title });
                    }
                }
                
                // --- Set default QR Code ---
                const defaultQrTitle = "Please donate to our charity through the QR Code below";
                const defaultQrUrl = "https://canalrivertrust.org.uk/support-us/donate";
                
                const tempDiv = document.createElement('div');
                new QRCode(tempDiv, {
                    text: defaultQrUrl,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                await new Promise(resolve => setTimeout(() => {
                    const canvas = tempDiv.querySelector('canvas');
                    if (canvas) {
                        const newQr = { id: Date.now(), title: defaultQrTitle, imageDataUrl: canvas.toDataURL(), url: defaultQrUrl };
                        qrCodes.push(newQr);
                        activeQrCodeId = newQr.id;
                    }
                    resolve();
                }, 200));

                // --- Set other defaults ---
                qrRotationTimeInput.value = 30;
                tickerMessages = [{id: Date.now(), text: "Welcome! Use Ctrl+M to open controls."}];
                eventItems = [{id: Date.now(), text: "New events will appear here."}];
                // No need to set default eventListTitle, it's handled by the state variable default
            }

            // Start clock
            updateClock();
            setInterval(updateClock, 1000);

            // Start banner rotation
            startBannerRotation();

            // Render everything
            renderEventTitle(); // Render the title on load
            updateTickerDisplay();
            renderPlaylistControls();
            renderEventLists();
            renderQrCodeList();
            renderActiveQrCode();
            renderTickerList();
            manageQrRotation();

            if (videoPlaylist.length > 0 && player) { // Check if player is ready
                playVideo(0);
            }
            if(isFirstLoad) saveState(); // Save the initial state with defaults
        }
        
        initializeApp();
    </script>
</body>
</html>
